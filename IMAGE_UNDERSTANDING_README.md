# 圖像理解功能說明

本項目集成了基於 Google GenAI 的智能圖像理解功能，能夠自動識別圖片中的文字內容、描述圖片內容、分析圖片特徵，並回答關於圖片的問題。

## 功能特點

- **智能模式選擇**：根據用戶消息內容自動選擇最適合的處理模式
- **多功能支持**：文字識別(OCR)、圖片描述、圖片分析、圖片問答
- **多語言支持**：支持中文、英文等多種語言的理解和回應
- **自動觸發**：當用戶發送圖片時，系統會智能判斷並自動處理
- **結果整合**：將分析結果自動添加到對話上下文中

## 處理模式

### 1. 文字識別模式 (OCR)
**觸發關鍵詞**: 文字、識別、ocr、讀取
- 識別圖片中的所有文字內容
- 保持原始排版格式
- 支持多種語言文字識別

### 2. 圖片描述模式
**觸發關鍵詞**: 描述、說明、內容、看到
- 詳細描述圖片的視覺內容
- 包括主要物體、場景、顏色、光線等
- 提供整體氛圍和風格描述

### 3. 圖片分析模式
**觸發關鍵詞**: 分析、解釋、什麼、這是
- 分析圖片類型和用途
- 識別重要元素和細節
- 提供專業的圖片解讀

### 4. 圖片問答模式
**觸發關鍵詞**: ?、？、問、如何、為什麼
- 根據用戶問題回答關於圖片的具體問題
- 支持複雜的圖片理解查詢
- 提供針對性的回答

### 5. 自動模式
**默認模式**：當沒有明確關鍵詞時
- 先嘗試文字識別
- 如果沒有文字，則自動切換到圖片描述
- 提供最合適的處理結果

## 技術實現

### 使用的技術

- **Google GenAI**: 基於 Gemini 2.0 Flash 模型的圖像理解 API
  - 模型: gemini-2.0-flash
  - 支持圖像輸入和多模態理解
  - 高準確率的文字識別和圖像理解

- **Node.js Fetch**: 用於圖片下載和 API 請求
  - 支持各種圖片格式
  - 自動處理 MIME 類型

### 工作流程

1. **圖片檢測**: 系統檢測到用戶發送的圖片附件
2. **模式判斷**: 根據用戶消息內容智能選擇處理模式
3. **圖片下載**: 從 Discord CDN 下載圖片並轉換為 base64
4. **API 請求**: 發送圖片和提示詞到 Google GenAI API
5. **結果處理**: 解析 API 回應並格式化結果
6. **上下文整合**: 將結果添加到對話歷史中

## 配置要求

### API 密鑰設置

需要設置 Google GenAI API 密鑰，支持以下環境變數：
- `GEMINI_API_KEY`
- `GOOGLE_API_KEY`
- 或在全局配置中設置 `global.GEMINI_API_KEYS`

### 模型參數

可以調整以下參數來優化理解效果：

```javascript
const config = {
  temperature: 0.1,      // 較低溫度獲得更準確結果
  topK: 32,             // 候選詞數量
  topP: 1,              // 累積概率閾值
  maxOutputTokens: 2048  // 最大輸出長度
};
```

## 使用方式

### 基本使用
1. **發送圖片**: 在 Discord 頻道中發送圖片
2. **添加描述**: 根據需要添加相應的關鍵詞或問題
3. **自動處理**: 系統會自動選擇最適合的處理模式
4. **查看結果**: 處理結果會自動顯示並添加到對話上下文

### 使用示例

```
用戶: [發送圖片] 請識別這張圖片中的文字
系統: [圖片文字識別結果: ...]

用戶: [發送圖片] 描述一下這張圖片的內容
系統: [圖片內容描述: ...]

用戶: [發送圖片] 這是什麼東西？
系統: [圖片分析結果: ...]

用戶: [發送圖片] 圖片中的人在做什麼？
系統: [圖片問答結果: ...]
```

## 注意事項

- 圖像理解準確率取決於圖片質量和內容清晰度
- 建議使用高分辨率、清晰的圖片
- 複雜場景或模糊圖片可能影響理解效果
- 需要穩定的網絡連接訪問 Google GenAI API
- API 調用可能產生費用，請注意使用量

## 故障排除

如果圖像理解功能無法正常工作，請檢查：

1. **API 密鑰**: 確保 Google GenAI API 密鑰已正確設置
2. **網絡連接**: 確保能夠訪問 Google GenAI API 和 Discord CDN
3. **圖片格式**: 支持常見的圖片格式（JPG、PNG、GIF、WebP 等）
4. **API 配額**: 檢查 API 使用配額是否充足
5. **權限設置**: 確保應用有網絡訪問權限